version: 0.2
env:
  variables:
    LAMBDA_FUNCTION_NAME: "testlambda"
    AWS_DEFAULT_REGION: "ap-southeast-2"

phases:
  install:
    runtime-versions:
      nodejs: 20
    commands:
      - echo "Installing Node.js dependencies..."
      - npm install --production || true

  build:
    commands:
      - echo "Build started..."
      - echo "Creating Lambda deployment package..."
      - zip -r function.zip . -x "buildspec*" "*.git*" "*.md" "node_modules/.cache/*" "function.zip"

  post_build:
    commands:
      - echo "Build completed on $(date)"
      - echo "Updating Lambda function code..."
      - aws lambda update-function-code \
          --function-name testlambda \
          --zip-file fileb://function.zip \
          --publish \
          --region ap-southeast-2
      - echo "âœ… Lambda function code updated successfully!"

artifacts:
  files:
    - 'function.zip'
  discard-paths: yes
